{"title":"egg-bull-board-adapter","uid":"985a6e9f306f90ab989025adc0137572","slug":"eggBullBoardAdapter","date":"2021-12-17T10:30:00.000Z","updated":"2022-09-28T07:19:23.108Z","comments":true,"path":"api/articles/eggBullBoardAdapter.json","keywords":null,"cover":"https://cycling-bucket.oss-cn-shenzhen.aliyuncs.com/littleboy/image-20211217181813598.png","content":"<h1 id=\"egg-bull-board-adapter\"><a href=\"#egg-bull-board-adapter\" class=\"headerlink\" title=\"egg-bull-board-adapter\"></a>egg-bull-board-adapter</h1><p><a href=\"https://github.com/littleboyfury/egg-bull-board\">egg-bull-board</a></p>\n<h2 id=\"产生原因\"><a href=\"#产生原因\" class=\"headerlink\" title=\"产生原因\"></a>产生原因</h2><p>egg.js 中不能直接使用 <code>@bull-board/koa</code> 中的 <code>KoaAdapter</code></p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; bull-board&#x2F;packages&#x2F;koa&#x2F;src&#x2F;KoaAdapter.ts&#x2F;registerPlugin()\n&#x2F;&#x2F; ......\nviewRoutes.forEach((path) &#x3D;&gt; &#123;\n  router[method](path, async (ctx) &#x3D;&gt; &#123;\n    const &#123; name &#125; &#x3D; handler();\n    \n    &#x2F;&#x2F; 在 eggjs 中回去调用 egg.views 中的 render 方法，会导致找不到 index.ejs 文件\n    &#x2F;&#x2F; 所以需要重写 ctx.render 方法，使其调用 koa-views 中的 render\n    await (ctx as any).render(name, &#123; basePath: this.basePath &#125;);\n  &#125;);\n&#125;);\n&#x2F;&#x2F; ......</code></pre>\n\n<h2 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; egg-bull-board&#x2F;src&#x2F;EggAdapter&#x2F;registerPlugin()\nimport views from &#39;koa-views&#39;\n&#x2F;&#x2F; ......\nviewRoutes.forEach((path) &#x3D;&gt; &#123;\n  router[method](path, async (ctx) &#x3D;&gt; &#123;\n    const &#123; name &#125; &#x3D; handler();\n\n    &#x2F;&#x2F; 调用 koa-views 中的方法覆盖 ctx.render 方法\n    (ctx as any).render &#x3D; views(this.staticPath, &#123;\n      extension: &#39;ejs&#39;,\n      map: &#39;ejs&#39;\n    &#125;)(null as any, null as any)\n    await (ctx as any).render(name, &#123; basePath: this.basePath &#125;)\n  &#125;)\n&#125;)\n&#x2F;&#x2F; ......</code></pre>\n\n<h2 id=\"egg-中使用\"><a href=\"#egg-中使用\" class=\"headerlink\" title=\"egg 中使用\"></a>egg 中使用</h2><ul>\n<li><p>装包，附带了 <code>@bull-board/ui</code> 和 <code>@bull-board/api</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">npm install @skyfury&#x2F;egg-bull-board -S</code></pre></li>\n<li><p>egg router.js</p>\n</li>\n</ul>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">&#39;use strict&#39;;\n\nconst Bull &#x3D; require(&#39;bull&#39;)\nconst &#123; EggAdapter &#125; &#x3D; require(&#39;@skyfury&#x2F;egg-bull-board&#39;)\nconst &#123; createBullBoard &#125; &#x3D; require(&#39;@bull-board&#x2F;api&#39;);\nconst &#123; BullAdapter &#125; &#x3D; require(&#39;@bull-board&#x2F;api&#x2F;bullAdapter&#39;);\n\nconst redisOptions &#x3D; &#123;\n  port: 6379,\n  host: &#39;localhost&#39;,\n  password: &#39;&#39;,\n  tls: false,\n&#125;;\n\nconst createQueue &#x3D; (name) &#x3D;&gt; new Bull(name, &#123; connection: redisOptions &#125;);\n\nmodule.exports &#x3D; app &#x3D;&gt; &#123;\n  const &#123; router, controller &#125; &#x3D; app;\n\n  const bullQueue &#x3D; createQueue(&#39;bull&#39;);\n  \n  &#x2F;&#x2F; 使用 EggAdapter\n  const serverAdapter &#x3D; new EggAdapter();\n  createBullBoard(&#123;\n    queues: [new BullAdapter(bullQueue)],\n    serverAdapter,\n  &#125;);\n  serverAdapter.setBasePath(&#39;&#x2F;ui&#39;);\n  app.use(serverAdapter.registerPlugin());\n  \n  router.get(&#39;&#x2F;add&#39;, async (ctx) &#x3D;&gt; &#123;\n    const opts &#x3D; ctx.query.opts || &#123;&#125;;\n\n    if (opts.delay) &#123;\n      opts.delay &#x3D; +opts.delay * 1000; &#x2F;&#x2F; delay must be a number\n    &#125;\n\n    await bullQueue.add(&#39;Add&#39;, &#123; title: ctx.query.title &#125;, opts);\n\n    ctx.body &#x3D; &#123;\n      ok: true,\n    &#125;;\n  &#125;);\n\n  console.log(&#96;For the UI of instance1, open http:&#x2F;&#x2F;localhost:$&#123;app.config.cluster.listen.port&#125;&#x2F;ui&#96;);\n  console.log(&#39;Make sure Redis is running on port 6379 by default&#39;);\n  console.log(&#39;To populate the queue, run:&#39;);\n  console.log(&#96;  curl http:&#x2F;&#x2F;localhost:$&#123;app.config.cluster.listen.port&#125;&#x2F;add?title&#x3D;Example&#96;);\n  console.log(&#39;To populate the queue with custom options (opts), run:&#39;);\n  console.log(&#96;  curl http:&#x2F;&#x2F;localhost:$&#123;app.config.cluster.listen.port&#125;&#x2F;add?title&#x3D;Test&amp;opts[delay]&#x3D;9&#96;);\n&#125;;\n</code></pre>\n","text":"egg-bull-board-adapteregg-bull-board 产生原因egg.js 中不能直接使用 @bull-board/koa 中的 KoaAdapter &#x2F;&#x2F; bull-board&#x2F;packages&#x2F;koa&#x2F;sr...","link":"","photos":[],"count_time":{"symbolsCount":"3.3k","symbolsTime":"3 mins."},"categories":[{"name":"后端","slug":"后端","count":2,"path":"api/categories/后端.json"}],"tags":[{"name":"JAVASCRIPT","slug":"JAVASCRIPT","count":14,"path":"api/tags/JAVASCRIPT.json"},{"name":"TYPESCRIPT","slug":"TYPESCRIPT","count":5,"path":"api/tags/TYPESCRIPT.json"},{"name":"EGGJS","slug":"EGGJS","count":1,"path":"api/tags/EGGJS.json"},{"name":"BULL-BOARD","slug":"BULL-BOARD","count":1,"path":"api/tags/BULL-BOARD.json"},{"name":"BULLJS","slug":"BULLJS","count":1,"path":"api/tags/BULLJS.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#egg-bull-board-adapter\"><span class=\"toc-text\">egg-bull-board-adapter</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0\"><span class=\"toc-text\">产生原因</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95\"><span class=\"toc-text\">解决办法</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#egg-%E4%B8%AD%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">egg 中使用</span></a></li></ol></li></ol>","author":{"name":"SKY","slug":"sky","avatar":"https://cycling-bucket.oss-cn-shenzhen.aliyuncs.com/littleboy/image-20211223171018733.png","link":"/","description":"Welcome to sky home","socials":{"github":"https://github.com/littleboyfury","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_38916811","juejin":"https://juejin.cn/user/2049948533144104","customs":{}}},"mapped":true,"prev_post":{"title":"GRPC TypeScript Timestamp to Date","uid":"a0308f1b66e47c358aa4918dab10369a","slug":"grpcTimestampToDate","date":"2021-12-28T16:00:00.000Z","updated":"2022-09-28T07:19:23.109Z","comments":true,"path":"api/articles/grpcTimestampToDate.json","keywords":null,"cover":"https://skyfuryblog.oss-cn-guangzhou.aliyuncs.com/img/1643424851939.png","text":"GRPC TypeScript TimeStamp to Date修改原因protobufjs 社区中没有针对 google 的包做处理，已经有了多个 PR，如果独立维护 protobufjs 是有成本的，间接性修改源码，以减少维护成本，所以选取了一个改动较小的代码进行使用 支持...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"后端","slug":"后端","count":2,"path":"api/categories/后端.json"}],"tags":[{"name":"TYPESCRIPT","slug":"TYPESCRIPT","count":5,"path":"api/tags/TYPESCRIPT.json"},{"name":"GRPC","slug":"GRPC","count":1,"path":"api/tags/GRPC.json"}],"author":{"name":"SKY","slug":"sky","avatar":"https://cycling-bucket.oss-cn-shenzhen.aliyuncs.com/littleboy/image-20211223171018733.png","link":"/","description":"Welcome to sky home","socials":{"github":"https://github.com/littleboyfury","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_38916811","juejin":"https://juejin.cn/user/2049948533144104","customs":{}}}},"next_post":{"title":"gitlab-runner","uid":"8c7191ccbfefacf8736e1c2ac855bf1e","slug":"gitlabRunner","date":"2021-12-17T06:30:00.000Z","updated":"2022-09-28T07:19:23.109Z","comments":true,"path":"api/articles/gitlabRunner.json","keywords":null,"cover":"https://cycling-bucket.oss-cn-shenzhen.aliyuncs.com/littleboy/image-20211217142322091.png","text":"gitlab-runnermac下安装 gitlab-runner其他系统可以参照官方文档gitlab runner install brew install gitlab-runner brew services start gitlab-runner .gitlab-ci.y...","link":"","photos":[],"count_time":{"symbolsCount":906,"symbolsTime":"1 mins."},"categories":[{"name":"教程","slug":"教程","count":5,"path":"api/categories/教程.json"}],"tags":[{"name":"GITLAB","slug":"GITLAB","count":1,"path":"api/tags/GITLAB.json"}],"author":{"name":"SKY","slug":"sky","avatar":"https://cycling-bucket.oss-cn-shenzhen.aliyuncs.com/littleboy/image-20211223171018733.png","link":"/","description":"Welcome to sky home","socials":{"github":"https://github.com/littleboyfury","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_38916811","juejin":"https://juejin.cn/user/2049948533144104","customs":{}}}}}